# åœ¨çº¿æ›´æ–°åŠŸèƒ½ä»£ç è¯¦è§£

## ğŸ“‹ ç›®å½•
1. [æ•´ä½“æ¶æ„](#æ•´ä½“æ¶æ„)
2. [æ ¸å¿ƒä»£ç é€è¡Œè®²è§£](#æ ¸å¿ƒä»£ç é€è¡Œè®²è§£)
3. [ç‰ˆæœ¬æ¯”è¾ƒç®—æ³•](#ç‰ˆæœ¬æ¯”è¾ƒç®—æ³•)
4. [æ­å»ºè§„åˆ™æœåŠ¡å™¨](#æ­å»ºè§„åˆ™æœåŠ¡å™¨)
5. [å®é™…ä½¿ç”¨ç¤ºä¾‹](#å®é™…ä½¿ç”¨ç¤ºä¾‹)
6. [å®‰å…¨æ€§è€ƒè™‘](#å®‰å…¨æ€§è€ƒè™‘)

---

## æ•´ä½“æ¶æ„

### å·¥ä½œæµç¨‹å›¾

```
ç”¨æˆ·ç‚¹å‡»"åœ¨çº¿æ›´æ–°"æŒ‰é’®
         â†“
[settings_dialog.py] update_rules_online()
         â†“
    æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
         â†“
   ç”¨æˆ·ç¡®è®¤ (Yes)
         â†“
[rule_manager.py] update_rules_online(url)
         â†“
    å‘é€ HTTP GET è¯·æ±‚
         â†“
    æ¥æ”¶ JSON å“åº”
         â†“
    è§£æè§„åˆ™æ•°æ®
         â†“
    æ¯”è¾ƒç‰ˆæœ¬å·
         â†“
   ç‰ˆæœ¬æ›´æ–°ï¼Ÿ
    /        \
  æ˜¯          å¦
   â†“          â†“
ä¿å­˜åˆ°æœ¬åœ°    è¿”å› False
   â†“
è¿”å› True
   â†“
åˆ·æ–°ç•Œé¢
   â†“
æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
```

### æ¶‰åŠçš„æ–‡ä»¶

1. **settings_dialog.py** - GUI å±‚ï¼šç”¨æˆ·äº¤äº’å’Œæ˜¾ç¤º
2. **rule_manager.py** - ä¸šåŠ¡é€»è¾‘å±‚ï¼šä¸‹è½½ã€æ¯”è¾ƒã€ä¿å­˜
3. **default_rules.json** - æ•°æ®å±‚ï¼šæœ¬åœ°è§„åˆ™å­˜å‚¨

---

## æ ¸å¿ƒä»£ç é€è¡Œè®²è§£

### 1. GUI å±‚ä»£ç ï¼ˆsettings_dialog.pyï¼‰

```python
def update_rules_online(self):
    """ä»åœ¨çº¿æºæ›´æ–°è§„åˆ™"""
    
    # æ­¥éª¤1: æ£€æŸ¥è§„åˆ™ç®¡ç†å™¨æ˜¯å¦å¯ç”¨
    if get_rule_manager is None:
        QMessageBox.warning(self, "åŠŸèƒ½ä¸å¯ç”¨", "è§„åˆ™ç®¡ç†å™¨æ¨¡å—æœªæ­£ç¡®åŠ è½½")
        return
    
    # æ­¥éª¤2: é…ç½®åœ¨çº¿è§„åˆ™åº“ URL
    # è¿™æ˜¯è§„åˆ™æœåŠ¡å™¨çš„åœ°å€ï¼Œéœ€è¦æ›¿æ¢ä¸ºå®é™…çš„æœåŠ¡å™¨åœ°å€
    online_url = "https://example.com/medical_rules.json"
    
    # æ­¥éª¤3: æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    # ç»™ç”¨æˆ·è¯´æ˜æ›´æ–°çš„å½±å“å’Œè¦æ±‚
    reply = QMessageBox.question(
        self,                    # çˆ¶çª—å£
        "åœ¨çº¿æ›´æ–°",                # å¯¹è¯æ¡†æ ‡é¢˜
        "ç¡®å®šè¦ä»äº‘ç«¯æ›´æ–°è§„åˆ™åº“å—ï¼Ÿ\n\n"
        "è¿™å°†è¦†ç›–å½“å‰çš„é»˜è®¤è§„åˆ™ï¼ˆç”¨æˆ·è‡ªå®šä¹‰è§„åˆ™ä¸å—å½±å“ï¼‰\n"
        "éœ€è¦ç½‘ç»œè¿æ¥æ‰èƒ½å®Œæˆæ›´æ–°",
        QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No
    )
    
    # æ­¥éª¤4: ç”¨æˆ·ç¡®è®¤åæ‰§è¡Œæ›´æ–°
    if reply == QMessageBox.StandardButton.Yes:
        try:
            # è·å–è§„åˆ™ç®¡ç†å™¨å®ä¾‹
            rule_mgr = get_rule_manager()
            
            # è°ƒç”¨æ ¸å¿ƒæ›´æ–°æ–¹æ³•
            if rule_mgr.update_rules_online(online_url):
                # æ›´æ–°æˆåŠŸï¼šé‡æ–°åŠ è½½è§„åˆ™åˆ°ç•Œé¢
                self.load_settings()
                QMessageBox.information(self, "æ›´æ–°æˆåŠŸ", "è§„åˆ™åº“å·²æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬")
            else:
                # æ— éœ€æ›´æ–°ï¼šå½“å‰ç‰ˆæœ¬å·²æ˜¯æœ€æ–°
                QMessageBox.information(self, "æ— éœ€æ›´æ–°", "å½“å‰è§„åˆ™å·²æ˜¯æœ€æ–°ç‰ˆæœ¬")
                
        except Exception as e:
            # æ­¥éª¤5: å¼‚å¸¸å¤„ç†
            # ç½‘ç»œé”™è¯¯ã€æœåŠ¡å™¨ä¸å¯ç”¨ç­‰æƒ…å†µ
            QMessageBox.warning(
                self, 
                "æ›´æ–°å¤±è´¥", 
                f"æ— æ³•è¿æ¥åˆ°è§„åˆ™æœåŠ¡å™¨\n\né”™è¯¯ä¿¡æ¯: {str(e)}\n\n"
                "è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜"
            )
```

#### ä»£ç è¦ç‚¹ï¼š

1. **é˜²å¾¡æ€§ç¼–ç¨‹**ï¼šå…ˆæ£€æŸ¥æ¨¡å—æ˜¯å¦åŠ è½½æˆåŠŸ
2. **ç”¨æˆ·ç¡®è®¤**ï¼šé‡è¦æ“ä½œå‰éœ€è¦ç”¨æˆ·æ˜ç¡®åŒæ„
3. **å‹å¥½æç¤º**ï¼šæ¸…æ¥šå‘ŠçŸ¥ç”¨æˆ·æ“ä½œçš„å½±å“
4. **å¼‚å¸¸å¤„ç†**ï¼šæ•è·å¹¶å‹å¥½åœ°æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
5. **çŠ¶æ€åŒæ­¥**ï¼šæ›´æ–°åç«‹å³åˆ·æ–°ç•Œé¢

---

### 2. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ï¼ˆrule_manager.pyï¼‰

```python
def update_rules_online(self, url: str) -> bool:
    """
    ä»åœ¨çº¿æºæ›´æ–°è§„åˆ™
    
    Args:
        url: è§„åˆ™æœåŠ¡å™¨çš„ URLï¼Œè¿”å› JSON æ ¼å¼çš„è§„åˆ™æ•°æ®
    
    Returns:
        bool: True=æ›´æ–°æˆåŠŸ, False=æ— éœ€æ›´æ–°æˆ–å¤±è´¥
    """
    try:
        # æ­¥éª¤1: å¯¼å…¥ requests åº“
        # åŠ¨æ€å¯¼å…¥ï¼Œé¿å…æœªå®‰è£…æ—¶ç¨‹åºå´©æºƒ
        import requests
        
        # æ­¥éª¤2: å‘é€ HTTP GET è¯·æ±‚
        response = requests.get(
            url,           # è§„åˆ™æœåŠ¡å™¨ URL
            timeout=10     # 10ç§’è¶…æ—¶ï¼Œé˜²æ­¢æ— é™ç­‰å¾…
        )
        
        # æ­¥éª¤3: æ£€æŸ¥ HTTP å“åº”çŠ¶æ€
        # raise_for_status() ä¼šåœ¨çŠ¶æ€ç  4xx/5xx æ—¶æŠ›å‡ºå¼‚å¸¸
        response.raise_for_status()
        
        # æ­¥éª¤4: è§£æ JSON å“åº”
        online_rules = response.json()
        # é¢„æœŸæ ¼å¼ï¼š
        # {
        #   "version": "1.1.0",
        #   "last_updated": "2025-10-17",
        #   "aliases": [...],
        #   "renames": [...],
        #   "gender_renames": [...]
        # }
        
        # æ­¥éª¤5: æå–åœ¨çº¿ç‰ˆæœ¬å·
        online_version = online_rules.get("version", "0.0.0")
        
        # æ­¥éª¤6: æ¯”è¾ƒç‰ˆæœ¬å·
        # self.version æ˜¯å½“å‰æœ¬åœ°è§„åˆ™çš„ç‰ˆæœ¬
        # _compare_version è¿”å›: 1=åœ¨çº¿æ›´æ–°, -1=æœ¬åœ°æ›´æ–°, 0=ç›¸åŒ
        if self._compare_version(online_version, self.version) > 0:
            
            # æ­¥éª¤7: åœ¨çº¿ç‰ˆæœ¬æ›´æ–°ï¼Œä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶
            with open(self.local_rules_file, 'w', encoding='utf-8') as f:
                json.dump(
                    online_rules,          # åœ¨çº¿è§„åˆ™æ•°æ®
                    f, 
                    ensure_ascii=False,    # ä¿ç•™ä¸­æ–‡å­—ç¬¦
                    indent=2               # æ ¼å¼åŒ–ï¼Œä¾¿äºé˜…è¯»
                )
            
            # æ­¥éª¤8: æ›´æ–°å†…å­˜ä¸­çš„è§„åˆ™æ•°æ®
            self.rules_data = online_rules
            self.version = online_version
            
            # æ­¥éª¤9: è®°å½•æ—¥å¿—
            logger.info(f"è§„åˆ™å·²æ›´æ–°åˆ°ç‰ˆæœ¬ {online_version}")
            return True
            
        else:
            # æœ¬åœ°ç‰ˆæœ¬ >= åœ¨çº¿ç‰ˆæœ¬ï¼Œæ— éœ€æ›´æ–°
            logger.info("å½“å‰è§„åˆ™å·²æ˜¯æœ€æ–°ç‰ˆæœ¬")
            return False
            
    except Exception as e:
        # æ­¥éª¤10: å¼‚å¸¸å¤„ç†
        # å¯èƒ½çš„å¼‚å¸¸ï¼š
        # - requests.exceptions.ConnectionError: ç½‘ç»œè¿æ¥å¤±è´¥
        # - requests.exceptions.Timeout: è¯·æ±‚è¶…æ—¶
        # - requests.exceptions.HTTPError: HTTP é”™è¯¯ï¼ˆ404/500ç­‰ï¼‰
        # - json.JSONDecodeError: JSON è§£æå¤±è´¥
        # - IOError: æ–‡ä»¶å†™å…¥å¤±è´¥
        logger.error(f"åœ¨çº¿æ›´æ–°è§„åˆ™å¤±è´¥: {e}")
        return False
```

#### ä»£ç è¦ç‚¹ï¼š

1. **è¶…æ—¶è®¾ç½®**ï¼š`timeout=10` é˜²æ­¢ç½‘ç»œè¯·æ±‚å¡æ­»
2. **çŠ¶æ€æ£€æŸ¥**ï¼š`raise_for_status()` ç¡®ä¿ HTTP å“åº”æˆåŠŸ
3. **ç‰ˆæœ¬æ¯”è¾ƒ**ï¼šåªæœ‰æ›´æ–°çš„ç‰ˆæœ¬æ‰ä¼šè¦†ç›–æœ¬åœ°
4. **åŸå­æ“ä½œ**ï¼šå…ˆå†™æ–‡ä»¶ï¼Œåæ›´æ–°å†…å­˜ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§
5. **æ—¥å¿—è®°å½•**ï¼šä¾¿äºè¿½è¸ªæ›´æ–°å†å²å’Œæ’æŸ¥é—®é¢˜
6. **å¼‚å¸¸å®‰å…¨**ï¼šä»»ä½•å¼‚å¸¸éƒ½ä¸ä¼šå¯¼è‡´ç¨‹åºå´©æºƒ

---

### 3. ç‰ˆæœ¬æ¯”è¾ƒç®—æ³•

```python
def _compare_version(self, v1: str, v2: str) -> int:
    """
    æ¯”è¾ƒä¸¤ä¸ªç‰ˆæœ¬å·
    
    ç‰ˆæœ¬å·æ ¼å¼: "ä¸»ç‰ˆæœ¬.æ¬¡ç‰ˆæœ¬.ä¿®è®¢ç‰ˆæœ¬"
    ä¾‹å¦‚: "1.2.3"
    
    Args:
        v1: ç¬¬ä¸€ä¸ªç‰ˆæœ¬å·ï¼ˆé€šå¸¸æ˜¯åœ¨çº¿ç‰ˆæœ¬ï¼‰
        v2: ç¬¬äºŒä¸ªç‰ˆæœ¬å·ï¼ˆé€šå¸¸æ˜¯æœ¬åœ°ç‰ˆæœ¬ï¼‰
    
    Returns:
        1: v1 > v2 (åœ¨çº¿ç‰ˆæœ¬æ›´æ–°)
        -1: v1 < v2 (æœ¬åœ°ç‰ˆæœ¬æ›´æ–°)
        0: v1 == v2 (ç‰ˆæœ¬ç›¸åŒ)
    """
    try:
        # æ­¥éª¤1: æ‹†åˆ†ç‰ˆæœ¬å·å­—ç¬¦ä¸²
        # "1.2.3" â†’ [1, 2, 3]
        v1_parts = [int(x) for x in v1.split('.')]
        v2_parts = [int(x) for x in v2.split('.')]
        
        # æ­¥éª¤2: é€ä½æ¯”è¾ƒ
        # å–ä¸¤ä¸ªç‰ˆæœ¬å·ä¸­è¾ƒé•¿çš„é•¿åº¦
        for i in range(max(len(v1_parts), len(v2_parts))):
            # è·å–ç¬¬ i ä½çš„å€¼ï¼Œä¸å­˜åœ¨åˆ™é»˜è®¤ä¸º 0
            p1 = v1_parts[i] if i < len(v1_parts) else 0
            p2 = v2_parts[i] if i < len(v2_parts) else 0
            
            # æ¯”è¾ƒå½“å‰ä½
            if p1 > p2:
                return 1    # v1 æ›´å¤§
            elif p1 < p2:
                return -1   # v2 æ›´å¤§
        
        # æ‰€æœ‰ä½éƒ½ç›¸ç­‰
        return 0
        
    except:
        # ç‰ˆæœ¬å·æ ¼å¼é”™è¯¯æ—¶ï¼Œè¿”å› 0ï¼ˆè§†ä¸ºç›¸åŒï¼‰
        # ä¾‹å¦‚: "1.x.3" æ— æ³•è§£æä¸ºæ•´æ•°
        return 0
```

#### ç®—æ³•ç¤ºä¾‹ï¼š

```python
# ç¤ºä¾‹1: åœ¨çº¿ç‰ˆæœ¬æ›´æ–°
_compare_version("1.2.0", "1.1.5") â†’ 1
# è§£æ: 1=1, 2>1, æ‰€ä»¥è¿”å› 1

# ç¤ºä¾‹2: æœ¬åœ°ç‰ˆæœ¬æ›´æ–°
_compare_version("1.0.5", "1.1.0") â†’ -1
# è§£æ: 1=1, 0<1, æ‰€ä»¥è¿”å› -1

# ç¤ºä¾‹3: ç‰ˆæœ¬ç›¸åŒ
_compare_version("1.2.3", "1.2.3") â†’ 0
# è§£æ: æ‰€æœ‰ä½éƒ½ç›¸ç­‰

# ç¤ºä¾‹4: é•¿åº¦ä¸åŒ
_compare_version("1.2", "1.2.0") â†’ 0
# è§£æ: 1=1, 2=2, (ç¼ºå¤±)0=0

# ç¤ºä¾‹5: å¤§ç‰ˆæœ¬æ›´æ–°
_compare_version("2.0.0", "1.9.9") â†’ 1
# è§£æ: 2>1, ç«‹å³è¿”å› 1
```

---

## ç‰ˆæœ¬æ¯”è¾ƒç®—æ³•

### è¯­ä¹‰åŒ–ç‰ˆæœ¬è§„èŒƒï¼ˆSemVerï¼‰

æˆ‘ä»¬éµå¾ª **è¯­ä¹‰åŒ–ç‰ˆæœ¬ 2.0.0** è§„èŒƒï¼š

```
ä¸»ç‰ˆæœ¬å·.æ¬¡ç‰ˆæœ¬å·.ä¿®è®¢ç‰ˆæœ¬å·
MAJOR.MINOR.PATCH

ä¾‹å¦‚: 1.2.3
      â”‚ â”‚ â””â”€ ä¿®è®¢ç‰ˆæœ¬ï¼šBugä¿®å¤
      â”‚ â””â”€â”€â”€ æ¬¡ç‰ˆæœ¬ï¼šæ–°åŠŸèƒ½ï¼ˆå‘åå…¼å®¹ï¼‰
      â””â”€â”€â”€â”€â”€ ä¸»ç‰ˆæœ¬ï¼šé‡å¤§å˜æ›´ï¼ˆå¯èƒ½ä¸å…¼å®¹ï¼‰
```

### æ›´æ–°ç­–ç•¥

```python
# è§„åˆ™åº“ç‰ˆæœ¬æ¼”è¿›ç¤ºä¾‹
"1.0.0"  # åˆå§‹ç‰ˆæœ¬
   â†“
"1.0.1"  # ä¿®å¤äº†å‡ ä¸ªåˆ«åé”™è¯¯
   â†“
"1.1.0"  # æ·»åŠ äº† 10 æ¡æ–°çš„åˆ«åè§„åˆ™
   â†“
"1.2.0"  # æ·»åŠ äº†æ€§åˆ«è§„åˆ™
   â†“
"2.0.0"  # é‡æ„è§„åˆ™æ ¼å¼ï¼ˆä¸å…¼å®¹æ—§ç‰ˆï¼‰
```

---

## æ­å»ºè§„åˆ™æœåŠ¡å™¨

### æ–¹æ¡ˆä¸€ï¼šä½¿ç”¨ Flask æ­å»ºç®€å•æœåŠ¡å™¨

```python
# server.py
from flask import Flask, jsonify
import json

app = Flask(__name__)

@app.route('/medical_rules.json')
def get_rules():
    """æä¾›è§„åˆ™ JSON æ•°æ®"""
    # è¯»å–è§„åˆ™æ–‡ä»¶
    with open('default_rules.json', 'r', encoding='utf-8') as f:
        rules = json.load(f)
    
    # è¿”å› JSON å“åº”
    return jsonify(rules)

@app.route('/version')
def get_version():
    """ä»…è¿”å›ç‰ˆæœ¬å·ï¼Œç”¨äºå¿«é€Ÿæ£€æŸ¥"""
    with open('default_rules.json', 'r', encoding='utf-8') as f:
        rules = json.load(f)
    return jsonify({
        'version': rules.get('version'),
        'last_updated': rules.get('last_updated')
    })

if __name__ == '__main__':
    # å¯åŠ¨æœåŠ¡å™¨
    app.run(host='0.0.0.0', port=8080, debug=False)
```

#### è¿è¡ŒæœåŠ¡å™¨

```bash
# å®‰è£…ä¾èµ–
pip install flask

# å¯åŠ¨æœåŠ¡å™¨
python server.py

# æµ‹è¯•è®¿é—®
curl http://localhost:8080/medical_rules.json
curl http://localhost:8080/version
```

---

### æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ Nginx æ‰˜ç®¡é™æ€æ–‡ä»¶

```nginx
# /etc/nginx/sites-available/medical-rules

server {
    listen 80;
    server_name rules.yourdomain.com;
    
    # è§„åˆ™æ–‡ä»¶ç›®å½•
    root /var/www/medical-rules;
    
    # è®¾ç½® CORS å…è®¸è·¨åŸŸè®¿é—®
    add_header Access-Control-Allow-Origin *;
    add_header Access-Control-Allow-Methods "GET, OPTIONS";
    
    location /medical_rules.json {
        # è¿”å› JSON æ–‡ä»¶
        default_type application/json;
        add_header Cache-Control "no-cache, must-revalidate";
    }
    
    # è®¿é—®æ—¥å¿—
    access_log /var/log/nginx/rules_access.log;
    error_log /var/log/nginx/rules_error.log;
}
```

#### éƒ¨ç½²æ­¥éª¤

```bash
# 1. åˆ›å»ºç›®å½•
sudo mkdir -p /var/www/medical-rules

# 2. å¤åˆ¶è§„åˆ™æ–‡ä»¶
sudo cp default_rules.json /var/www/medical-rules/medical_rules.json

# 3. è®¾ç½®æƒé™
sudo chown -R www-data:www-data /var/www/medical-rules

# 4. å¯ç”¨ç«™ç‚¹
sudo ln -s /etc/nginx/sites-available/medical-rules /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx

# 5. æµ‹è¯•è®¿é—®
curl http://rules.yourdomain.com/medical_rules.json
```

---

### æ–¹æ¡ˆä¸‰ï¼šä½¿ç”¨ GitHub/Gitee æ‰˜ç®¡ï¼ˆæœ€ç®€å•ï¼‰

```python
# ç›´æ¥ä½¿ç”¨ GitHub Raw æ–‡ä»¶ URL
online_url = "https://raw.githubusercontent.com/username/repo/main/default_rules.json"

# æˆ–ä½¿ç”¨ Giteeï¼ˆå›½å†…è®¿é—®æ›´å¿«ï¼‰
online_url = "https://gitee.com/username/repo/raw/master/default_rules.json"
```

#### ä¼˜ç‚¹ï¼š
- âœ… å…è´¹
- âœ… è‡ªåŠ¨ç‰ˆæœ¬ç®¡ç†
- âœ… æ”¯æŒå¤šäººåä½œ
- âœ… è‡ªåŠ¨å¤‡ä»½

#### è®¾ç½®æ­¥éª¤ï¼š

```bash
# 1. åˆ›å»º Git ä»“åº“
git init medical-rules
cd medical-rules

# 2. æ·»åŠ è§„åˆ™æ–‡ä»¶
cp /path/to/default_rules.json .
git add default_rules.json
git commit -m "Initial rules version 1.0.0"

# 3. æ¨é€åˆ° GitHub
git remote add origin https://github.com/username/medical-rules.git
git push -u origin main

# 4. åœ¨ä»£ç ä¸­ä½¿ç”¨ Raw URL
```

---

## å®é™…ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: åŸºæœ¬ä½¿ç”¨

```python
from rule_manager import get_rule_manager

# è·å–è§„åˆ™ç®¡ç†å™¨
rule_mgr = get_rule_manager()

# é…ç½®æœåŠ¡å™¨ URL
server_url = "https://your-server.com/medical_rules.json"

# æ‰§è¡Œæ›´æ–°
success = rule_mgr.update_rules_online(server_url)

if success:
    print("âœ“ è§„åˆ™æ›´æ–°æˆåŠŸ")
    print(f"æ–°ç‰ˆæœ¬: {rule_mgr.version}")
else:
    print("â—‹ å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬")
```

---

### ç¤ºä¾‹ 2: å®šæ—¶è‡ªåŠ¨æ›´æ–°

```python
import schedule
import time
from rule_manager import get_rule_manager

def auto_update_rules():
    """è‡ªåŠ¨æ›´æ–°è§„åˆ™ï¼ˆæ¯å¤©æ‰§è¡Œä¸€æ¬¡ï¼‰"""
    rule_mgr = get_rule_manager()
    url = "https://your-server.com/medical_rules.json"
    
    try:
        if rule_mgr.update_rules_online(url):
            print(f"[{time.strftime('%Y-%m-%d %H:%M:%S')}] è§„åˆ™å·²æ›´æ–°åˆ° v{rule_mgr.version}")
        else:
            print(f"[{time.strftime('%Y-%m-%d %H:%M:%S')}] å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬")
    except Exception as e:
        print(f"[{time.strftime('%Y-%m-%d %H:%M:%S')}] æ›´æ–°å¤±è´¥: {e}")

# æ¯å¤©å‡Œæ™¨ 2 ç‚¹æ‰§è¡Œæ›´æ–°
schedule.every().day.at("02:00").do(auto_update_rules)

# å¯åŠ¨å®šæ—¶ä»»åŠ¡
print("å®šæ—¶æ›´æ–°ä»»åŠ¡å·²å¯åŠ¨...")
while True:
    schedule.run_pending()
    time.sleep(60)  # æ¯åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡
```

---

### ç¤ºä¾‹ 3: å¸¦è¿›åº¦æç¤ºçš„æ›´æ–°

```python
from PyQt6.QtWidgets import QProgressDialog, QMessageBox
from PyQt6.QtCore import QThread, pyqtSignal
from rule_manager import get_rule_manager

class UpdateWorker(QThread):
    """åå°æ›´æ–°çº¿ç¨‹"""
    finished = pyqtSignal(bool, str)  # (æˆåŠŸ, æ¶ˆæ¯)
    
    def __init__(self, url):
        super().__init__()
        self.url = url
    
    def run(self):
        try:
            rule_mgr = get_rule_manager()
            success = rule_mgr.update_rules_online(self.url)
            
            if success:
                msg = f"è§„åˆ™å·²æ›´æ–°åˆ°ç‰ˆæœ¬ {rule_mgr.version}"
            else:
                msg = "å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
            
            self.finished.emit(success, msg)
        except Exception as e:
            self.finished.emit(False, f"æ›´æ–°å¤±è´¥: {str(e)}")

class MainWindow:
    def update_rules_with_progress(self):
        """å¸¦è¿›åº¦æ¡çš„æ›´æ–°"""
        # æ˜¾ç¤ºè¿›åº¦å¯¹è¯æ¡†
        progress = QProgressDialog("æ­£åœ¨è¿æ¥æœåŠ¡å™¨...", None, 0, 0, self)
        progress.setWindowTitle("æ›´æ–°è§„åˆ™")
        progress.setWindowModality(Qt.WindowModality.WindowModal)
        progress.show()
        
        # åˆ›å»ºæ›´æ–°çº¿ç¨‹
        url = "https://your-server.com/medical_rules.json"
        self.worker = UpdateWorker(url)
        
        # è¿æ¥ä¿¡å·
        self.worker.finished.connect(lambda success, msg: self.on_update_finished(progress, success, msg))
        
        # å¯åŠ¨æ›´æ–°
        self.worker.start()
    
    def on_update_finished(self, progress, success, message):
        """æ›´æ–°å®Œæˆå›è°ƒ"""
        progress.close()
        
        if success:
            QMessageBox.information(self, "æ›´æ–°æˆåŠŸ", message)
        else:
            QMessageBox.information(self, "æç¤º", message)
```

---

### ç¤ºä¾‹ 4: æ£€æŸ¥æ›´æ–°è€Œä¸è‡ªåŠ¨ä¸‹è½½

```python
import requests
from rule_manager import get_rule_manager

def check_for_updates(url):
    """æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ–°å¯ç”¨"""
    try:
        rule_mgr = get_rule_manager()
        
        # è·å–åœ¨çº¿ç‰ˆæœ¬ä¿¡æ¯
        response = requests.get(url, timeout=10)
        response.raise_for_status()
        online_rules = response.json()
        online_version = online_rules.get("version", "0.0.0")
        
        # æ¯”è¾ƒç‰ˆæœ¬
        if rule_mgr._compare_version(online_version, rule_mgr.version) > 0:
            print(f"å‘ç°æ–°ç‰ˆæœ¬: {online_version}")
            print(f"å½“å‰ç‰ˆæœ¬: {rule_mgr.version}")
            
            # æ˜¾ç¤ºæ›´æ–°å†…å®¹ï¼ˆå¦‚æœæœåŠ¡å™¨æä¾›ï¼‰
            changelog = online_rules.get("changelog", "")
            if changelog:
                print(f"æ›´æ–°å†…å®¹:\n{changelog}")
            
            return True, online_version
        else:
            print("å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬")
            return False, rule_mgr.version
            
    except Exception as e:
        print(f"æ£€æŸ¥æ›´æ–°å¤±è´¥: {e}")
        return False, None

# ä½¿ç”¨
has_update, version = check_for_updates("https://your-server.com/medical_rules.json")
if has_update:
    user_input = input(f"æ˜¯å¦æ›´æ–°åˆ°ç‰ˆæœ¬ {version}? (y/n): ")
    if user_input.lower() == 'y':
        # æ‰§è¡Œæ›´æ–°...
        pass
```

---

## å®‰å…¨æ€§è€ƒè™‘

### 1. HTTPS åŠ å¯†ä¼ è¾“

```python
# âœ… æ¨èï¼šä½¿ç”¨ HTTPS
online_url = "https://secure-server.com/medical_rules.json"

# âŒ ä¸æ¨èï¼šæ˜æ–‡ HTTPï¼ˆå¯èƒ½è¢«ä¸­é—´äººæ”»å‡»ï¼‰
online_url = "http://insecure-server.com/medical_rules.json"
```

### 2. æ•°å­—ç­¾åéªŒè¯

```python
import hashlib
import requests

def update_rules_with_verification(url, signature_url):
    """å¸¦ç­¾åéªŒè¯çš„æ›´æ–°"""
    # ä¸‹è½½è§„åˆ™æ–‡ä»¶
    response = requests.get(url)
    rules_data = response.text
    
    # ä¸‹è½½ç­¾å
    sig_response = requests.get(signature_url)
    expected_signature = sig_response.text.strip()
    
    # è®¡ç®—æ–‡ä»¶å“ˆå¸Œ
    actual_signature = hashlib.sha256(rules_data.encode()).hexdigest()
    
    # éªŒè¯ç­¾å
    if actual_signature == expected_signature:
        # ç­¾ååŒ¹é…ï¼Œä¿å­˜æ–‡ä»¶
        with open('default_rules.json', 'w') as f:
            f.write(rules_data)
        return True
    else:
        raise ValueError("ç­¾åéªŒè¯å¤±è´¥ï¼Œæ–‡ä»¶å¯èƒ½è¢«ç¯¡æ”¹")
```

### 3. ç™½åå•æœºåˆ¶

```python
# åªå…è®¸ä»å¯ä¿¡æœåŠ¡å™¨æ›´æ–°
TRUSTED_SERVERS = [
    "https://official-server.com",
    "https://backup-server.com",
]

def update_rules_online(self, url: str) -> bool:
    # æ£€æŸ¥ URL æ˜¯å¦åœ¨ç™½åå•ä¸­
    if not any(url.startswith(server) for server in TRUSTED_SERVERS):
        raise ValueError(f"ä¸å—ä¿¡ä»»çš„æœåŠ¡å™¨: {url}")
    
    # ç»§ç»­æ›´æ–°æµç¨‹...
```

### 4. å›æ»šæœºåˆ¶

```python
import shutil
from datetime import datetime

def update_with_backup(url):
    """å¸¦å¤‡ä»½çš„æ›´æ–°ï¼Œå¤±è´¥æ—¶å¯å›æ»š"""
    # å¤‡ä»½å½“å‰è§„åˆ™
    backup_file = f"default_rules.backup.{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
    shutil.copy2('default_rules.json', backup_file)
    
    try:
        # æ‰§è¡Œæ›´æ–°
        rule_mgr = get_rule_manager()
        success = rule_mgr.update_rules_online(url)
        
        if success:
            print(f"âœ“ æ›´æ–°æˆåŠŸï¼Œå¤‡ä»½å·²ä¿å­˜åˆ°: {backup_file}")
        return success
        
    except Exception as e:
        # æ›´æ–°å¤±è´¥ï¼Œæ¢å¤å¤‡ä»½
        print(f"âœ— æ›´æ–°å¤±è´¥: {e}")
        print(f"æ­£åœ¨æ¢å¤å¤‡ä»½: {backup_file}")
        shutil.copy2(backup_file, 'default_rules.json')
        raise

def rollback_to_version(backup_file):
    """å›æ»šåˆ°æŒ‡å®šå¤‡ä»½ç‰ˆæœ¬"""
    shutil.copy2(backup_file, 'default_rules.json')
    print(f"âœ“ å·²å›æ»šåˆ°å¤‡ä»½: {backup_file}")
```

---

## é«˜çº§åŠŸèƒ½æ‰©å±•

### 1. å·®é‡æ›´æ–°

```python
def incremental_update(url):
    """å·®é‡æ›´æ–°ï¼šåªä¸‹è½½å˜åŒ–çš„éƒ¨åˆ†"""
    rule_mgr = get_rule_manager()
    
    # è¯·æ±‚å¤´åŒ…å«å½“å‰ç‰ˆæœ¬
    headers = {
        'If-None-Match': rule_mgr.version,
        'X-Current-Version': rule_mgr.version
    }
    
    response = requests.get(url, headers=headers)
    
    if response.status_code == 304:
        # 304 Not Modified: æ— æ›´æ–°
        return False
    
    # è¿”å›å·®é‡æ•°æ®
    delta = response.json()
    # delta = {
    #   "add": [...],      # è¦æ·»åŠ çš„è§„åˆ™
    #   "remove": [...],   # è¦åˆ é™¤çš„è§„åˆ™
    #   "update": [...]    # è¦æ›´æ–°çš„è§„åˆ™
    # }
    
    # åº”ç”¨å·®é‡...
```

### 2. å¤šæœåŠ¡å™¨å®¹é”™

```python
MIRROR_SERVERS = [
    "https://primary-server.com/rules.json",
    "https://backup-server-1.com/rules.json",
    "https://backup-server-2.com/rules.json",
]

def update_from_mirrors():
    """ä»é•œåƒæœåŠ¡å™¨æ›´æ–°ï¼Œè‡ªåŠ¨å®¹é”™"""
    for url in MIRROR_SERVERS:
        try:
            print(f"å°è¯•ä»æœåŠ¡å™¨æ›´æ–°: {url}")
            rule_mgr = get_rule_manager()
            if rule_mgr.update_rules_online(url):
                print(f"âœ“ ä» {url} æ›´æ–°æˆåŠŸ")
                return True
        except Exception as e:
            print(f"âœ— ä» {url} æ›´æ–°å¤±è´¥: {e}")
            continue
    
    print("âœ— æ‰€æœ‰æœåŠ¡å™¨éƒ½æ— æ³•è¿æ¥")
    return False
```

### 3. æ›´æ–°é€šçŸ¥

```python
class RuleUpdateNotifier:
    """è§„åˆ™æ›´æ–°é€šçŸ¥å™¨"""
    
    def check_and_notify(self, url):
        """æ£€æŸ¥æ›´æ–°å¹¶é€šçŸ¥ç”¨æˆ·"""
        has_update, new_version = check_for_updates(url)
        
        if has_update:
            # å‘é€æ¡Œé¢é€šçŸ¥
            self.send_desktop_notification(
                "è§„åˆ™åº“æœ‰æ–°ç‰ˆæœ¬",
                f"å‘ç°æ–°ç‰ˆæœ¬ {new_version}ï¼Œç‚¹å‡»æ›´æ–°"
            )
            
            # æˆ–å‘é€é‚®ä»¶é€šçŸ¥
            self.send_email_notification(new_version)
    
    def send_desktop_notification(self, title, message):
        """å‘é€æ¡Œé¢é€šçŸ¥ï¼ˆWindows/macOS/Linuxï¼‰"""
        try:
            from plyer import notification
            notification.notify(
                title=title,
                message=message,
                app_icon=None,
                timeout=10,
            )
        except:
            pass
```

---

## æ€»ç»“

### æ ¸å¿ƒè¦ç‚¹

1. **åˆ†å±‚è®¾è®¡**ï¼šGUI å±‚ã€ä¸šåŠ¡é€»è¾‘å±‚ã€æ•°æ®å±‚åˆ†ç¦»
2. **ç‰ˆæœ¬æ§åˆ¶**ï¼šä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬ï¼Œæ™ºèƒ½æ¯”è¾ƒ
3. **å¼‚å¸¸å®‰å…¨**ï¼šå®Œå–„çš„é”™è¯¯å¤„ç†å’Œå›æ»šæœºåˆ¶
4. **çµæ´»éƒ¨ç½²**ï¼šæ”¯æŒå¤šç§æœåŠ¡å™¨æ–¹æ¡ˆ
5. **å®‰å…¨å¯é **ï¼šHTTPSã€ç­¾åéªŒè¯ã€ç™½åå•

### æœ€ä½³å®è·µ

- âœ… ä½¿ç”¨ HTTPS ç¡®ä¿ä¼ è¾“å®‰å…¨
- âœ… è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
- âœ… åšå¥½å¼‚å¸¸å¤„ç†å’Œç”¨æˆ·æç¤º
- âœ… æ›´æ–°å‰å¤‡ä»½ï¼Œå¤±è´¥æ—¶å¯å›æ»š
- âœ… è®°å½•è¯¦ç»†æ—¥å¿—ä¾¿äºæ’æŸ¥é—®é¢˜
- âœ… æ”¯æŒå¤šä¸ªé•œåƒæœåŠ¡å™¨æé«˜å¯ç”¨æ€§

### ä¸‹ä¸€æ­¥

1. ğŸ“ æ ¹æ®å®é™…éœ€æ±‚ä¿®æ”¹ `online_url`
2. ğŸš€ æ­å»ºè§„åˆ™æœåŠ¡å™¨ï¼ˆæ¨èä½¿ç”¨ GitHubï¼‰
3. ğŸ§ª æµ‹è¯•å®Œæ•´çš„æ›´æ–°æµç¨‹
4. ğŸ“Š ç›‘æ§æ›´æ–°æˆåŠŸç‡å’Œå¤±è´¥åŸå› 
5. ğŸ”„ å®šæœŸæ›´æ–°è§„åˆ™åº“ç‰ˆæœ¬

---

**ç›¸å…³æ–‡æ¡£ï¼š**
- `RULE_MANAGEMENT.md` - è§„åˆ™ç®¡ç†å®Œæ•´æŒ‡å—
- `å¿«é€Ÿä¸Šæ‰‹æŒ‡å—.md` - 5åˆ†é’Ÿå…¥é—¨
- `è§£å†³æ–¹æ¡ˆæ€»ç»“.md` - æ•´ä½“æ–¹æ¡ˆè¯´æ˜

