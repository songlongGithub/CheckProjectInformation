# 在线更新功能测试指南

## 🎯 快速开始

### 第一步：安装依赖

```bash
# 安装 Flask（用于测试服务器）
pip install flask

# 或安装所有依赖
pip install -r requirements.txt
```

---

### 第二步：启动测试服务器

打开**第一个终端窗口**：

```bash
cd /Users/shtexaisonglong/Documents/python/checkProjectInformation
python3 test_update_server.py
```

你会看到：

```
============================================================
医疗规则更新服务器 - 测试版
============================================================

当前版本: 1.2.0
可用版本: 1.0.0, 1.1.0, 1.2.0

服务器地址: http://localhost:5000
规则接口: http://localhost:5000/medical_rules.json
版本信息: http://localhost:5000/version

按 Ctrl+C 停止服务器

============================================================
 * Running on http://0.0.0.0:5000
```

**保持这个终端窗口运行！**

---

### 第三步：运行测试客户端

打开**第二个终端窗口**：

```bash
cd /Users/shtexaisonglong/Documents/python/checkProjectInformation
python3 test_online_update.py
```

你会看到交互式菜单：

```
============================================================
在线更新功能测试菜单
============================================================
1. 执行在线更新
2. 测试版本比较算法
3. 检查是否有新版本
4. 更新到指定版本
5. 查看服务器所有版本
0. 退出
============================================================

请选择操作 (0-5):
```

---

## 📖 各功能测试说明

### 测试 1: 执行在线更新

选择 `1`，程序会：

1. 显示当前本地规则版本
2. 连接到测试服务器
3. 比较版本号
4. 如果服务器版本更新，自动下载并保存
5. 显示更新后的规则信息

**预期结果：**

```
当前本地规则:
  版本: 1.0.0
  更新时间: 2025-10-17
  别名规则: 38 条
  重命名规则: 4 条
  性别规则: 1 条

正在从服务器更新: http://localhost:5000/medical_rules.json

✓ 更新成功！

更新后的规则:
  版本: 1.2.0
  更新时间: 2025-10-18
  别名规则: 5 条
  重命名规则: 2 条
  性别规则: 1 条
  更新说明: 新增重命名规则和性别规则
```

---

### 测试 2: 测试版本比较算法

选择 `2`，程序会：

演示版本号比较的各种情况

**预期结果：**

```
版本比较测试:
在线版本      本地版本      比较结果          说明
------------------------------------------------------------
1.2.0       1.1.5       需要更新 ↑      在线版本更新
1.0.5       1.1.0       无需更新 ↓      本地版本更新
1.2.3       1.2.3       版本相同 ≡      版本相同
2.0.0       1.9.9       需要更新 ↑      大版本更新
1.2         1.2.0       版本相同 ≡      长度不同（相同）
```

---

### 测试 3: 检查是否有新版本

选择 `3`，程序会：

1. 查询服务器的最新版本号
2. 与本地版本比较
3. 显示是否有更新可用
4. **不会自动下载**

**预期结果：**

```
当前本地版本: 1.0.0
正在检查服务器版本: http://localhost:5000/version
服务器最新版本: 1.2.0

✓ 发现新版本: 1.2.0
更新内容: 新增重命名规则和性别规则

可以执行更新操作
```

---

### 测试 4: 更新到指定版本

选择 `4`，程序会：

1. 显示服务器所有可用版本
2. 让你选择要更新到哪个版本
3. 下载并安装指定版本

**交互流程：**

```
可用的测试版本:
  1. 版本 1.0.0
  2. 版本 1.1.0
  3. 版本 1.2.0

当前本地版本: 1.2.0

请选择要更新的版本 (1-3，回车跳过): 2

正在更新到版本 1.1.0...
✓ 成功更新到版本 1.1.0
```

**用途：** 可以用来测试版本回滚功能

---

### 测试 5: 查看服务器所有版本

选择 `5`，程序会：

显示服务器上所有可用的规则版本

**预期结果：**

```
服务器可用版本列表:
版本        更新时间         规则数      说明
------------------------------------------------------------
1.0.0     2025-10-17     2         初始版本
1.1.0     2025-10-17     5         新增 5 条别名规则
1.2.0     2025-10-18     5         新增重命名规则和性别规则
```

---

## 🔍 验证更新是否成功

### 方法 1: 查看 JSON 文件

```bash
# 查看当前规则文件的版本号
cat default_rules.json | grep version
```

### 方法 2: 在 GUI 中查看

```bash
# 启动应用
python3 main.py

# 打开设置对话框
# 查看规则表格内容是否更新
```

### 方法 3: 使用 Python 脚本

```python
import json

with open('default_rules.json', 'r', encoding='utf-8') as f:
    rules = json.load(f)
    print(f"当前版本: {rules['version']}")
    print(f"别名规则数: {len(rules['aliases'])}")
```

---

## 🧪 测试场景

### 场景 1: 首次更新

```bash
# 1. 确保本地是旧版本（手动修改 version 为 "1.0.0"）
# 2. 运行测试客户端
# 3. 选择 "1. 执行在线更新"
# 4. 验证更新到 1.2.0
```

**预期：** ✅ 更新成功

---

### 场景 2: 已是最新版本

```bash
# 1. 执行一次更新到最新版 1.2.0
# 2. 再次执行更新
```

**预期：** ○ 提示"当前已是最新版本"

---

### 场景 3: 网络故障

```bash
# 1. 停止测试服务器（Ctrl+C）
# 2. 运行测试客户端并尝试更新
```

**预期：** ✗ 显示"无法连接到规则服务器"错误

---

### 场景 4: 版本回滚

```bash
# 1. 当前版本 1.2.0
# 2. 选择 "4. 更新到指定版本"
# 3. 选择版本 1.0.0
```

**预期：** ✅ 成功回滚到 1.0.0（规则数量减少）

---

## 🌐 使用真实服务器

### 修改服务器 URL

编辑 `test_online_update.py`：

```python
# 将 localhost 改为真实服务器地址
server_url = "http://localhost:5000/medical_rules.json"
# 改为：
server_url = "https://your-server.com/medical_rules.json"
```

或在 `settings_dialog.py` 中修改：

```python
# 第 403 行
online_url = "https://your-server.com/medical_rules.json"
```

---

## 📊 服务器 API 说明

测试服务器提供以下接口：

### 1. 获取规则

```bash
GET http://localhost:5000/medical_rules.json
```

**响应：**

```json
{
  "version": "1.2.0",
  "last_updated": "2025-10-18",
  "changelog": "新增重命名规则和性别规则",
  "aliases": [...],
  "renames": [...],
  "gender_renames": [...]
}
```

---

### 2. 获取版本信息

```bash
GET http://localhost:5000/version
```

**响应：**

```json
{
  "version": "1.2.0",
  "last_updated": "2025-10-18",
  "changelog": "新增重命名规则和性别规则"
}
```

---

### 3. 列出所有版本

```bash
GET http://localhost:5000/versions
```

**响应：**

```json
[
  {
    "version": "1.0.0",
    "last_updated": "2025-10-17",
    "changelog": "初始版本",
    "rule_count": 2
  },
  {
    "version": "1.1.0",
    "last_updated": "2025-10-17",
    "changelog": "新增 5 条别名规则",
    "rule_count": 5
  }
]
```

---

### 4. 获取指定版本

```bash
GET http://localhost:5000/medical_rules.json?version=1.1.0
```

---

### 5. 健康检查

```bash
GET http://localhost:5000/health
```

**响应：**

```json
{
  "status": "healthy",
  "timestamp": "2025-10-17T22:30:00"
}
```

---

## 🐛 故障排查

### 问题 1: 连接被拒绝

**错误信息：**
```
ConnectionError: Connection refused
```

**解决方法：**
1. 确认测试服务器是否启动
2. 检查端口 5000 是否被占用
3. 尝试更换端口号

---

### 问题 2: Flask 未安装

**错误信息：**
```
ModuleNotFoundError: No module named 'flask'
```

**解决方法：**
```bash
pip install flask
```

---

### 问题 3: 请求超时

**错误信息：**
```
Timeout: Request timeout after 10 seconds
```

**解决方法：**
1. 检查网络连接
2. 增加超时时间
3. 检查服务器是否响应慢

---

### 问题 4: JSON 解析失败

**错误信息：**
```
JSONDecodeError: Expecting value
```

**解决方法：**
1. 检查服务器返回的内容格式
2. 确认是否返回 HTML 错误页面
3. 查看服务器日志

---

## 💡 扩展测试

### 测试自定义服务器

创建自己的规则文件 `my_rules.json`：

```json
{
  "version": "2.0.0",
  "last_updated": "2025-10-19",
  "changelog": "自定义规则版本",
  "aliases": [
    ["自定义别名1", "标准名1"],
    ["自定义别名2", "标准名2"]
  ],
  "renames": [],
  "gender_renames": []
}
```

修改 `test_update_server.py` 加载你的文件。

---

### 测试大规则文件

```python
# 生成 1000 条测试规则
large_rules = {
    "version": "3.0.0",
    "aliases": [[f"test{i}", f"标准{i}"] for i in range(1000)]
}
```

---

### 测试并发更新

```bash
# 同时运行多个客户端
python3 test_online_update.py &
python3 test_online_update.py &
python3 test_online_update.py &
```

---

## 📝 总结

### 测试完成后

1. ✅ 理解了在线更新的完整流程
2. ✅ 掌握了版本比较算法
3. ✅ 知道如何搭建规则服务器
4. ✅ 了解了各种错误处理情况

### 下一步

1. 📝 修改 `settings_dialog.py` 中的服务器 URL
2. 🚀 搭建生产环境的规则服务器
3. 📊 监控更新成功率和用户反馈
4. 🔄 定期更新规则库版本

---

**相关文档：**
- `在线更新功能详解.md` - 详细代码讲解
- `RULE_MANAGEMENT.md` - 规则管理完整指南
- `快速上手指南.md` - 5分钟入门

